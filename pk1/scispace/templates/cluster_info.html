{% extends 'space_base.html' %}
{% load staticfiles %}

{% block main %}

  <div class="row">
    {% if cluster %}
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">{{ cluster.name }}</div>
        <div class="card-body">
            <table class="table">
              <tbody>
                {% for k,v in cluster.items%}
                <tr>
                  <th>{{k}}</th>
                  <td>{{v}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
        </div>

        <!-- <div class="panel-footer"><a href="" class="btn btn-info">OPEN</a></div> -->

      </div>
            
      </div>

    
    <div class="col-md-12" id="metrics_parent" style="margin-bottom: 50px;">
      <h4 class="page-header" style="margin-top: 20px;">
        Cluster Overview
      </h4>
      <div id="metrics_div" class="row" ></div> 
    </div>     

    <div class="col-md-12" id="dataset_parent" style="margin-bottom: 50px;">
      <h4 class="page-header"  style="margin-top: 20px;">
        Dataset Overview
      </h4>
      <div class="row">
      <div id="dataset_1" class="col-md-6" style="height: 300px;"></div>
      <div id="dataset_2" class="col-md-6" style="height: 300px;"></div>
      </div>
    </div>

    <div class="col-md-12" id="instance_parent" style="margin-bottom: 50px;">    
      <h4 class="page-header"  style="margin-top: 20px;">
        Instance Overview
      </h4>
      <div id="instance_1" style="height: 300px;"></div>
    </div>

    <div class="col-md-12" id="pipeline_parent" style="margin-bottom: 50px;">
      <h4 class="page-header"  style="margin-top: 20px;">
        Pipeline Overview
      </h4>
      <div id="pipeline_div">        
      </div>
    </div>
    
    <div class="col-md-12" id="notebook_parent" style="margin-bottom: 50px;">
      <h4 class="page-header"  style="margin-top: 20px;">
        Notebook Overview
      </h4>
      <div id="notebook_div"></div>
    </div>
    <script type="text/javascript" src="{% static 'scispace/js/echarts.min.js' %}"></script>
    <script type="text/javascript">
      var metric_data_url = "/space/{{cluster.id}}/api/data/state/";
      var piflow_data_url = "{{pipeline_api_url}}";
      var zeppelin_data_url = "{{notebook_api_url}}";
      jQuery(function($) {
        $.get( metric_data_url, function(data) {
          var metics_array = data.cluster.metics;
          if (metics_array && metics_array.length > 0) {
              var metics_div = document.getElementById("metrics_div");
              var content_eles = "";
              for (var i = 0; i < metics_array.length; i++) {                
                  content_eles += ('<div id="disk' + i + '" class="col-md-6" style="height:300px;"></div>');                  
              }           
              metrics_div.innerHTML = (content_eles);

              for (var i = 0; i < metics_array.length; i++) {

                  var disk_div_element = document.getElementById('disk' + i);
                  var diskChart = echarts.init(disk_div_element);

                  var metics_array_i = metics_array[i];
                  for(var k in metics_array_i){
                    metics_array_i = metics_array_i[k]
                    break;
                  }
                  
                  var option = {
                      title: {
                          text: metics_array_i.Hosts.host_name + ' 统计',
                          //subtext: '虚构数据',
                          left: 'center'
                      },
                      color: ['#99d2dd', '#1c7099'],
                      tooltip: {
                          trigger: 'item',
                          formatter: "{a} <br/>{b} : {c}"
                      },
                      series: [
                          {
                              name: '磁盘空间',
                              type: 'pie',
                              radius: '50%',
                              center: ['35%', '60%'],
                              data: [{
                                  value: metics_array_i.metrics.disk.disk_free,
                                  name: '磁盘空闲'
                              }, {
                                  value: (metics_array_i.metrics.disk.disk_total - metics_array_i.metrics.disk.disk_free).toFixed(2),
                                  name: '磁盘使用'
                              }],
                              itemStyle: {
                                  emphasis: {
                                      show: true,
                                      textStyle: {
                                          fontSize: '20',
                                          fontWeight: 'bold'
                                      }
                                  },
                                  normal: {
                                      position: 'center',
                                      label: {
                                          formatter: function(a, b, c, d) {
                                            return a.data.name + '：' + a.data.value + 'GB ';
                                          },
                                          textStyle: {
                                              baseline: 'top',
                                              fontSize: '12',
                                              fontWeight: 'bold'
                                          }
                                      }
                                  },
                              }
                          },
                          {
                              name: '内存已使用(GB)',
                              type: 'gauge',
                              radius: '70%',
                              center: ['70%', '50%'],
                              min: 0,
                              max: (metics_array_i.metrics.memory.mem_total/(1024*1024)).toFixed(1),
                              axisLine: {            // 坐标轴线
                                  lineStyle: {       // 属性lineStyle控制线条样式
                                      width: 10
                                  }
                              },
                              axisTick: {            // 坐标轴小标记
                                  length: 15,        // 属性length控制线长
                                  lineStyle: {       // 属性lineStyle控制线条样式
                                      color: 'auto'
                                  }
                              },
                              splitLine: {           // 分隔线
                                  length: 20,         // 属性length控制线长
                                  lineStyle: {       // 属性lineStyle（详见lineStyle）控制线条样式
                                      color: 'auto'
                                  }
                              },
                              //detail: {formatter:'{value}'},
                              data: [{
                                  value: ((metics_array_i.metrics.memory.mem_total - metics_array_i.metrics.memory.mem_free)/(1024*1024)).toFixed(2), 
                                  name: '内存(GB)'
                                  }]
                          }
                      ]
                  };
                  diskChart.setOption(option);
              }
          }
          else{
            // hidden parent element
            var pr = document.getElementById("metrics_parent");
            pr.style.display="none";
          }

          var data_sets_type_cnt = data.dataset.type_cnt;
          if (data_sets_type_cnt && data_sets_type_cnt.length > 0) {
              var dataset_div_element_1 = document.getElementById('dataset_1');
              var dataset_chart_1_option_data_x = [];
              var dataset_chart_1_option_data_y = [];
              for (var i = 0; i < data_sets_type_cnt.length; i++) {
                  dataset_chart_1_option_data_x.push(data_sets_type_cnt[i].type);
                  dataset_chart_1_option_data_y.push(data_sets_type_cnt[i].cnt);
              }
              var dataset_chart_1 = echarts.init(dataset_div_element_1);
              var dataset_chart_1_option = {
                  title: {
                      text: '各种类型数据数量',
                      subtext: '',
                      left: 'center'
                  },
                  color: ['#3398DB'],
                  tooltip: {
                      trigger: 'axis',
                      axisPointer: { // 坐标轴指示器，坐标轴触发有效
                          type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                      }
                  },
                  grid: {
                      left: '3%',
                      right: '4%',
                      bottom: '3%',
                      containLabel: true
                  },
                  xAxis: [{
                      type: 'category',
                      //data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                      data: dataset_chart_1_option_data_x,
                      axisTick: {
                          alignWithLabel: true
                      }
                  }],
                  yAxis: [{
                      type: 'value',
                      axisLabel:{formatter:'{value}'}
                  }],
                  series: [{
                      name: '大小',
                      type: 'bar',
                      barWidth: '60%',
                      //data: [10, 51, 100, 334, 390, 330, 110]
                      data: dataset_chart_1_option_data_y
                  }]
              };
              dataset_chart_1.setOption(dataset_chart_1_option);
          }

          var data_sets_type_size = data.dataset.type_size;
          if (data_sets_type_size && data_sets_type_size.length > 0) {
              var dataset_div_element_2 = document.getElementById('dataset_2');
              var dataset_chart_2_option_data_x = [];
              var dataset_chart_2_option_data_y = [];
              for (var i = 0; i < data_sets_type_size.length; i++) {
                  dataset_chart_2_option_data_x.push(data_sets_type_size[i].type);
                  dataset_chart_2_option_data_y.push(data_sets_type_size[i].size);
              }
              var dataset_chart_2 = echarts.init(dataset_div_element_2);
              var dataset_chart_2_option = {
                  title: {
                      text: '各种类型数据占用空间',
                      subtext: '',
                      left: 'center'
                  },
                  color: ['#3398DB'],
                  tooltip: {
                      trigger: 'axis',
                      axisPointer: { // 坐标轴指示器，坐标轴触发有效
                          type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                      }
                  },
                  grid: {
                      left: '3%',
                      right: '4%',
                      bottom: '3%',
                      containLabel: true
                  },
                  xAxis: [{
                      type: 'category',
                      //data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                      data: dataset_chart_2_option_data_x,
                      axisTick: {
                          alignWithLabel: true
                      }
                  }],
                  yAxis: [{
                      type: 'value',
                      axisLabel:{formatter:'{value} KB'}
                  }],
                  series: [{
                      name: '大小：',
                      type: 'bar',
                      barWidth: '60%',
                      //data: [10, 52, 200, 334, 390, 330, 220]
                      data: dataset_chart_2_option_data_y,
                      normal: {
                          position: 'center',
                          label: {
                              formatter: function(a, b, c, d) {
                                  //return a.data.name + '：' + (a.data.value / 7601 * 100).toFixed(2) + '%<br>';
                                  return a.data.name + '：' + a.data.value + 'GB ';
                              }
                          }
                      },
                  }]
              };
              dataset_chart_2.setOption(dataset_chart_2_option);
          }

          if(!data_sets_type_size && !data_sets_type_cnt){
            // hidden parent element
            var pr = document.getElementById("dataset_parent");
            pr.style.display="none";
          }

          var data_instance_type_cnt = data.instance.type_cnt;
          if (data_instance_type_cnt && data_instance_type_cnt.length > 0) {
              var instance_div_element_1 = document.getElementById('instance_1');
              var instance_chart_1_option_data_x = [];
              var instance_chart_1_option_data_y = [];
              for (var i = 0; i < data_instance_type_cnt.length; i++) {
                  instance_chart_1_option_data_x.push(data_instance_type_cnt[i].dataset__type);
                  instance_chart_1_option_data_y.push(data_instance_type_cnt[i].cnt);
              }
              var instance_chart_1 = echarts.init(instance_div_element_1);
              var instance_chart_1_option = {
                  title: {
                      text: '',
                      subtext: '',
                      left: 'center'
                  },
                  color: ['#3398DB'],
                  tooltip: {
                      trigger: 'axis',
                      axisPointer: { // 坐标轴指示器，坐标轴触发有效
                          type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                      }
                  },
                  grid: {
                      left: '3%',
                      right: '4%',
                      bottom: '3%',
                      containLabel: true
                  },
                  xAxis: [{
                      type: 'category',
                      //data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                      data: instance_chart_1_option_data_x,
                      axisTick: {
                          alignWithLabel: true
                      }
                  }],
                  yAxis: [{
                      type: 'value'
                  }],
                  series: [{
                      name: '数量',
                      type: 'bar',
                      barWidth: '60%',
                      //data: [10, 52, 200, 334, 390, 330, 220]
                      data: instance_chart_1_option_data_y
                  }]
              };
              instance_chart_1.setOption(instance_chart_1_option);
          }
          else{
            // hidden parent element
            var pr = document.getElementById("instance_parent");
            pr.style.display="none";
          }
        });

        $.get( piflow_data_url, function(result) {
          if (result) {
              var rtnMap = JSON.parse(result);
              if (1 === rtnMap.code) {
                  var result_data = rtnMap.data;
                  if (result_data && result_data.length > 0) {
                      var pipeline_div = document.getElementById("pipeline_div");
                      var content_eles = "<ol>";                      
                      for (var i = 0; i < result_data.length; i++) {
                          content_eles += ('<li>' + result_data[i].name + '</li>')
                      }
                      content_eles += "</ol>";
                      pipeline_div.innerHTML = content_eles;
                  }
              }
          }
        });

        $.get(zeppelin_data_url, function(result) {
          if (result) {
              if ("OK" === result.status) {
                var result_body = result.body;
                if (result_body && result_body.length > 0) {
                    var notebook_div = document.getElementById("notebook_div");
                    var content_eles = "<ol>"; 
                    for (var i = 0; i < result_body.length; i++) {
                        content_eles += ('<li>' + result_body[i].name + '</li>')
                    }
                    content_eles += "</ol>";
                    notebook_div.innerHTML = content_eles;
                }
              }
          }
        });

      });
    </script>

    {% endif %}
  </div>

{% endblock %}
